---
title: "Group Task"
author: "Phong Duong"
format:
  html:
    theme: [style.scss]
    toc: true
    toc-location: right
    toc-title: Índice
editor: visual
---

# Required packages

> Insert in the lower chunk the packages you will need

```{r}
rm(list = ls()) 
library(tidyverse)
library(dbplyr)
library(RSQLite)
library(DBI)
library(lubridate)
library(scales)
```

# Data

```{r}
db <- DBI::dbConnect(SQLite(), "database.sqlite", extended_types = T)
dbListTables(db)
```

# Data Processing

```{r}

```

# Questions

1.  How is the vote of national parties (PSOE, PP, VOX, CS, MP, UP - IU) distributed against regional or nationalist parties?

```{r}
q1_df <- tbl(db, "election_data_2") %>% 
  select(cod_mun, elec_date, party, vote_count) %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>% 
  mutate(nat_reg = ifelse(siglas_2 %in% c('PSOE', 'PP','VOX', 'CS', 'MP', 'UP-IU'),'national', 'regional'))
```

```{r}
#Create a table in sql db for faster data retrieval
vote_sum <- q1_df %>% 
  group_by(nat_reg, elec_date) %>% 
  summarise(vote_total = sum(vote_count)) 
vote_sum %>% head()
compute(vote_sum, temporary = FALSE, name='vote_sum')
tbl(db, "vote_sum")
```

```{r}
plot1_data <- tbl(db, "vote_sum") 
ggplot(plot1_data) +
  geom_col(aes(x = elec_date, y = vote_total/10^6, fill = nat_reg), position = position_dodge2()) +
  labs(y = "Total votes (in millions)")
```

2.  Which party was the winner in the municipalities with more than 100,000 habitants (census) in each of the elections?

```{r}
tbl(db, "election_data") %>% 
  select(-tipo_eleccion, -vuelta, -codigo_distrito_electoral) %>% 
  mutate(date = as.Date(paste(anno, mes, '01', sep = '-'))) %>% 
  select(-mes, -anno, -codigo_ccaa, -codigo_provincia, -codigo_municipio) %>% 
  group_by(date, cod_mun) %>% 
  mutate(valid_votes = sum(vote_count) + votos_blancos,
         percent = vote_count/ valid_votes * 100) %>% 
  head()
```

3.  Which party was the second when the first was the PSOE? And when the first was the PP?

```{r}

```

4.  Who benefits from low turnout?

```{r}

```

5.  How to analyze the relationship between census and vote? Is it true that certain parties win in rural areas?

```{r}

```

6.  How to calibrate the error of the polls (remember that the polls are voting intentions at national level)?

```{r}

```

7.  In which election were the polls most wrong?

```{r}

```

8.  How were the polls wrong in national parties (PSOE, PP, VOX, CS, MP, UP - IU)?

```{r}

```

9.  Which polling houses got it right the most and which ones deviated the most from the results?

```{r}

```
