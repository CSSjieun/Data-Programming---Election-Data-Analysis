---
title: "Group Task"
author: "Phong Duong"
format:
  html:
    theme: [style.scss]
    toc: true
    toc-location: right
    toc-title: Índice
editor: visual
---

# Required packages

> Insert in the lower chunk the packages you will need

```{r}
rm(list = ls()) 
library(tidyverse)
library(dbplyr)
library(RSQLite)
library(DBI)
library(lubridate)
library(scales)
```

# Data

```{r}
db <- DBI::dbConnect(SQLite(), "database.sqlite", extended_types = T)
dbListTables(db)
```

# Data Processing

```{r}

```

# Questions

1.  How is the vote of national parties (PSOE, PP, VOX, CS, MP, UP - IU) distributed against regional or nationalist parties?

```{r}
q1_df <- tbl(db, "election_data_2") %>% 
  select(cod_mun, elec_date, party, vote_count) %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>% 
  mutate(nat_reg = ifelse(siglas_2 %in% c('PSOE', 'PP','VOX', 'CS', 'MP', 'UP-IU'),'national', 'regional'))
```

```{r}
#Create a table in sql db for faster data retrieval
vote_sum <- q1_df %>% 
  group_by(nat_reg, elec_date) %>% 
  summarise(vote_total = sum(vote_count)) 
vote_sum %>% head()
compute(vote_sum, temporary = FALSE, name='vote_sum')
tbl(db, "vote_sum")
```

```{r}
plot1_data <- tbl(db, "vote_sum") 
ggplot(plot1_data) +
  geom_col(aes(x = elec_date, y = vote_total/10^6, fill = nat_reg), position = position_dodge2()) +
  labs(y = "Total votes (in millions)")
```

2.  Which party was the winner in the municipalities with more than 100,000 habitants (census) in each of the elections?

```{r}
vote_full <- tbl(db, "election_data_2") %>% 
  group_by(elec_date, cod_mun) %>% 
  mutate(valid_votes = sum(vote_count) + votos_blancos,
         percent = vote_count/ valid_votes * 100) %>% 
  select(elec_date, cod_mun, party, vote_count, valid_votes, percent)

compute(vote_full, temporary = FALSE, name = "vote_full")
```

```{r}
mun_pop_2 <- tbl(db, "municipal_population") %>% 
  mutate(date = paste(as.integer(anno), mes, "01", sep = "-" )) %>% 
  select(-anno, -mes) 

winner_100k <- tbl(db, "vote_full") %>% 
  left_join(mun_pop_2, by = join_by("cod_mun", "elec_date" == "date")) %>% 
  filter(censo_total > 100000) %>% 
  group_by(elec_date, cod_mun) %>% 
  filter(percent == max(percent)) 
```

```{r}
#2008
winner_100k %>% filter(as.Date(elec_date) == 2008) %>%
  group_by(party) %>% 
  summarise(wins = count()) %>% 
  arrange(desc(wins))

#2011
winner_100k %>% filter(as.Date(elec_date) == 2011) %>%
  group_by(party) %>% 
  summarise(wins = count()) %>% 
  arrange(desc(wins))

#2015
winner_100k %>% filter(as.Date(elec_date) == 2015) %>%
  group_by(party) %>% 
  summarise(wins = count()) %>% 
  arrange(desc(wins))

#2019-1
winner_100k %>% filter(elec_date == "2019-04-01") %>%
  group_by(party) %>% 
  summarise(wins = count()) %>% 
  arrange(desc(wins))

#2019-2
winner_100k %>% filter(elec_date == "2019-11-01") %>%
  group_by(party) %>% 
  summarise(wins = count()) %>% 
  arrange(desc(wins))

```

```{r}
winner_100k_summary <- winner_100k %>% 
  group_by(elec_date, party) %>% 
  summarise(wins = count()) %>% 
  filter(wins == max(wins)) %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>% 
  collect() 

ggplot(winner_100k_summary) +
  geom_col(aes(x= elec_date, y = wins, fill = siglas_2)) +
  geom_text(aes(x = elec_date, y = wins,label = siglas_2), nudge_y = 1) +
  theme(legend.position = "none") 
```

3.  Which party was the second when the first was the PSOE? And when the first was the PP?

```{r}
first_second <- tbl(db, "vote_full") %>% 
  left_join(mun_pop_2, by = join_by("cod_mun", "elec_date" == "date")) %>% 
  filter(censo_total > 100000) %>% 
  relocate(censo_total, .after = cod_mun) %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>% 
  relocate(siglas_2, .after = party) %>% 
  group_by(elec_date, cod_mun) %>% 
  arrange(elec_date, cod_mun) %>% #Check if this necessary
  slice_max(vote_count, n = 2) %>% 
  collect()
```

```{r}
#First is PSOE

#Count how many times got second place
first_second %>% 
  filter(siglas_2[1] == "PSOE") %>% 
  filter(siglas_2 != "PSOE") %>% ungroup() %>% 
  select(elec_date, party, siglas_2, percent) %>% 
  group_by(elec_date, siglas_2) %>% 
  summarise(count = n()) %>% 
  arrange(elec_date, desc(count))

#Sum votes per election of second place party
first_second %>% 
  summarise(first = siglas_2[1],
            second = siglas_2[2],
            
             votes_first = sum(vote_count[siglas_2 == first]),
             votes_second = sum(vote_count[siglas_2 == second]),
            .groups = 'drop' ) %>% 
   
  filter(first== "PSOE") %>% 
  ungroup() %>% 
   
  group_by(elec_date, second, first) %>% 
  summarise(count_second = sum(votes_second), 
            count_first = sum(votes_first), 
            .groups = 'drop') %>% 
 group_by(elec_date) %>% 
 filter(count_second == max(count_second))
```

```{r}
#First is PP

#Count how many times got second place
first_second %>% 
  filter(siglas_2[1] == "PP") %>% 
  filter(siglas_2 != "PP") %>% ungroup() %>% 
  select(elec_date, party, siglas_2, percent) %>% 
  group_by(elec_date, siglas_2) %>% 
  summarise(count = n()) %>% 
  arrange(elec_date, desc(count))

#Sum votes per election of second place party
first_second %>% 
  summarise(first = siglas_2[1],
            second = siglas_2[2],
            
             votes_first = sum(vote_count[siglas_2 == first]),
             votes_second = sum(vote_count[siglas_2 == second]),
            .groups = 'drop' ) %>% 
   
  filter(first== "PP") %>% 
  ungroup() %>% 
   
  group_by(elec_date, second, first) %>% 
  summarise(count_second = sum(votes_second), 
            count_first = sum(votes_first), 
            .groups = 'drop') %>% 
 group_by(elec_date) %>% 
 filter(count_second == max(count_second))
```

4.  Who benefits from low turnout?

```{r}
#Long run time, consider optimizing 
tbl(db,"election_data_2") %>% 
  left_join(tbl(db, "abbrev_2"),by = join_by("party" == "denominacion")) %>% 
  left_join(mun_pop_2, by = join_by("cod_mun", "elec_date" == "date")) %>% 
  group_by(elec_date, cod_mun) %>% 
  mutate(participation_pcg = participacion_2/censo_total * 100) %>% 
  select(elec_date, cod_mun, party, siglas_2, participacion_2, vote_count, participation_pcg, censo_total) %>% 
  filter(participation_pcg < 30) %>% 
  arrange(participation_pcg) %>% 
  filter(vote_count == max(vote_count)) %>% 
  head()
```

5.  How to analyze the relationship between census and vote? Is it true that certain parties win in rural areas?

```{r}
q5_df <- tbl(db, "vote_full") %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>%
  filter(siglas_2 != "OTHER") %>% 
  left_join(mun_pop_2, by = join_by("cod_mun", "elec_date" == "date")) %>% 
  select(elec_date, cod_mun, censo_total, party, siglas_2, vote_count, valid_votes) %>% collect()

cor(q5_df$censo_total, q5_df$valid_votes)
```

```{r}
#Vote data frame of interested parties and in rural area (population <= 5000)
#Criteria for rural based on DEMOGRAFÍA DE LA POBLACIÓN RURAL en 2020
rural_winners <- tbl(db, "vote_full") %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>% 
  filter(siglas_2 != "OTHER") %>% 
  left_join(mun_pop_2, by = join_by("cod_mun", "elec_date" == "date")) %>%
  filter(censo_total <= 5000) %>% 
  collect()

#Winning times in rural zones per party per elections 
rural_winners %>% 
  group_by(elec_date, cod_mun) %>% 
  filter(percent == max(percent)) %>% 
  group_by(elec_date, siglas_2) %>% 
  summarise(win_count = n()) %>% 
  arrange(elec_date,desc(win_count))
```

```{r}
#2008
rural_winners %>% 
  group_by(elec_date, cod_mun) %>% 
  filter(percent == max(percent) & elec_date == "2008-03-01") %>% 
  ggplot(aes(x = percent, fill = siglas_2)) +
  geom_histogram()
```

6.  How to calibrate the error of the polls (remember that the polls are voting intentions at national level)?

```{r}

```

7.  In which election were the polls most wrong?

```{r}

```

8.  How were the polls wrong in national parties (PSOE, PP, VOX, CS, MP, UP - IU)?

```{r}

```

9.  Which polling houses got it right the most and which ones deviated the most from the results?

```{r}

```
