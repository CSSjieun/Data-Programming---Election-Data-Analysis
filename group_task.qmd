---
title: "Group Task"
author: "Phong Duong"
format:
  html:
    theme: [style.scss]
    toc: true
    toc-location: right
    toc-title: Índice
editor: visual
---

# Required packages

> Insert in the lower chunk the packages you will need

```{r}
rm(list = ls()) 
library(tidyverse)
library(dbplyr)
library(RSQLite)
library(DBI)
```

# Data

```{r}
db <- DBI::dbConnect(SQLite(), "database.sqlite", extended_types = T)
dbListTables(db)
```

# Data Processing

```{r}

```

# Questions

1.  How is the vote of national parties (PSOE, PP, VOX, CS, MP, UP - IU) distributed against regional or nationalist parties?

```{r}
q1_df <- tbl(db, "election_data") %>% 
  select(cod_mun, anno, mes, party, vote_count) %>% 
  left_join(tbl(db, "abbrev_2"), by = join_by("party" == "denominacion")) %>% 
  mutate(nat_reg = ifelse(siglas_2 %in% c('PSOE', 'PP','VOX', 'CS', 'MP', 'UP-IU'),'national', 'regional'))
q1_df %>% filter(is.na(siglas))
```

```{r}
#Create a table in sql db for faster data retrieval
vote_sum_year <- q1_df %>% 
  group_by(nat_reg, anno) %>% 
  summarise(vote_total = sum(vote_count)) 
compute(vote_sum_year, temporary = FALSE, name='vote_sum_year')
```

```{r}
plot1_data <- tbl(db, "vote_sum_year") 
ggplot(plot1_data) +
  geom_col(aes(x = anno, y = vote_total, fill = nat_reg), position = position_dodge2()) +
  scale_x_discrete(limits = c(2008,2011,2015,2016,2019))
```

2.  Which party was the winner in the municipalities with more than 100,000 habitants (census) in each of the elections?

```{r}

```

3.  Which party was the second when the first was the PSOE? And when the first was the PP?

```{r}

```

4.  Who benefits from low turnout?

```{r}

```

5.  How to analyze the relationship between census and vote? Is it true that certain parties win in rural areas?

```{r}

```

6.  How to calibrate the error of the polls (remember that the polls are voting intentions at national level)?

```{r}

```

7.  In which election were the polls most wrong?

```{r}

```

8.  How were the polls wrong in national parties (PSOE, PP, VOX, CS, MP, UP - IU)?

```{r}

```

9.  Which polling houses got it right the most and which ones deviated the most from the results?

```{r}

```
